{% extends "../base.html" %}
{% block title %}Graph{% endblock title %}
{% block head_css %}
  <link rel="stylesheet" href="test.css">
{% endblock head_css %}
{% block content %}
  <div class="wrapper">
      <div id="selectContainer">
          <div class="form-check">
              <input class="form-check-input" type="checkbox" value="current">
              <label class="form-check-label" for="1">current</label>
          </div>
          <div class="form-check">
              <input class="form-check-input" type="checkbox" value="rpm">
              <label class="form-check-label" for="2">rpm</label>
          </div>
          <div class="form-check">
              <input class="form-check-input" type="checkbox" value="duty">
              <label class="form-check-label" for="3">duty</label>
          </div>
          <div class="form-check">
              <input class="form-check-input" type="checkbox" value="voltage">
              <label class="form-check-label" for="4">voltage</label>
          </div>
          <div><button type="submit" id="generateButton">Generate</button></div>
      </div>
      <div id="chartContainer" style="height: 300px; width: 100%;"></div>
  </div>
{% endblock content %}
{% block footer_scripts %}
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.5.0/jquery.min.js"></script>
  <script src="https://canvasjs.com/assets/script/canvasjs.min.js"></script>
  <script>
  //put graph generation code here

  //On load function, get our data and do any setup required
  $(document).ready(function() {
    //sample data, real data will be loaded from database
    var importedData = '{{mydata|safe}}';
    var parsedData = JSON.parse(importedData)
    var header = parsedData.header
    var data = parsedData.data
    var timeStamp = data[0][0]

    var newData = [];
    var axisY = [];
    for(var i in header) {
        if (i == 0){
          continue;
        }
        newData.push({
            type:"line",
            name: header[i],
            showInLegend: true,
            markerSize: 0,
            axisYIndex: parseInt(i - 1),
            dataPoints: []
        })
        axisY.push({
            tickThickness: 0,
            tickLength: 0,
            lineThickness:0,
            margin:0,
            labelFormatter: function(e) {
              return "";
            }
        })
    }

    // newData[k-1] matches k key:value pair of data[j]
    for(var j in data) {
        for(var k in data[j]){
            if (k != 0){
                var newTime = data[j][0] - timeStamp
                newData[k-1].dataPoints.push({x:newTime, y:parseFloat(data[j][k])})
            }
        }
    }
    generateChart([]);

    //
    // FUNCTIONS
    // Generates chart
    function generateChart(selected) {

        var chart = new CanvasJS.Chart("chartContainer", {
            zoomEnabled: true,
            panEnabled: true,
            title: {
                text: "Your e-Foil"
            },
            axisX: {
                title: "Time",
                suffix: "s"
            },
            axisY: axisY,
            toolTip: {
                shared: true
            },
            legend: {
                cursor: "pointer",
                verticalAlign: "left",
                horizontalAlign: "center",
                dockInsidePlotArea: false
            },
            data: newData
        });

        // check if selected has values - initially empty
        if (selected.length > 0){
            for (var i in dataIncluded){
                if (!selected.includes(dataIncluded[i])){ //if checked in checkbox
                    chart.options.data[i].visible = false;
                } else {
                    chart.options.data[i].visible = true;
                }
            }
        }
        chart.render()
    }

     // Determines which data has been selected for viewing -> () => array
     function displayData() {
        var selectedData = [];
        $(".form-check-input").each(function() {
            if($(this).is(":checked")){
                selectedData.push($(this).val())
            }
        })
        return selectedData;
     }
    // Runs when the generate button is clicked.  Calls generateChart with the selected elements
    $("#generateButton").click(function() {
        var selected = displayData()
        console.log(selected);
        generateChart(selected);
    })

  })
  </script>
{% endblock footer_scripts %}
